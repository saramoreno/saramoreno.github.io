"use strict";(self.webpackChunkbonsai_web=self.webpackChunkbonsai_web||[]).push([[568],{9522:function(e,t,n){n.d(t,{Kj:function(){return U}});var r=n(885),a=n(7326),i=n(1752),s=n(136),o=n(6215),h=n(1120),l=n(3144),u=n(5671),c=n(4687),d=n.n(c),f=n(4174),v=n(8517),g=n(3192),_=n(7032),m=n(5203),y=n(8911),I=n(6900),p=n(7046),M=n(1396),b=n(2845),D=n(4527),S=n(7662),x=n(9370),B=n(65),A=n(6556),k=n(2402),P=n(6639),w=n(9336),C=n(2328),O=n(1704),F=n(5230),T=n(3767),V=n(9609);function R(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return L(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return L(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,s=!0,o=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){o=!0,i=e},f:function(){try{s||null==n.return||n.return()}finally{if(o)throw i}}}}function L(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function E(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,h.Z)(e);if(t){var a=(0,h.Z)(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return(0,o.Z)(this,n)}}var W=(0,l.Z)((function e(){(0,u.Z)(this,e),this.visibleInstances={},this.batchCache=new N,this.batchCacheReplacementModeInFrozenMode=new N,this.instancesBufferSize=2048})),N=(0,l.Z)((function e(){(0,u.Z)(this,e),this.mustReturn=!1,this.visibleInstances=new Array,this.renderSelf=new Array,this.hardwareInstancedRendering=new Array})),K=(0,l.Z)((function e(){(0,u.Z)(this,e),this.instancesCount=0,this.matrixBuffer=null,this.previousMatrixBuffer=null,this.matrixBufferSize=512,this.matrixData=null,this.boundingVectors=[],this.worldMatrices=null})),z=(0,l.Z)((function e(){(0,u.Z)(this,e),this._areNormalsFrozen=!1,this._source=null,this.meshMap=null,this._preActivateId=-1,this._LODLevels=new Array,this._useLODScreenCoverage=!1,this._effectiveMaterial=null,this._forcedInstanceCount=0})),U=function(e){(0,s.Z)(n,e);var t=E(n);function n(e){var r,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,h=arguments.length>4?arguments[4]:void 0,l=!(arguments.length>5&&void 0!==arguments[5])||arguments[5];if((0,u.Z)(this,n),(r=t.call(this,e,i))._internalMeshDataInfo=new z,r.delayLoadState=0,r.instances=new Array,r._creationDataStorage=null,r._geometry=null,r._instanceDataStorage=new W,r._thinInstanceDataStorage=new K,r._shouldGenerateFlatShading=!1,r._originalBuilderSideOrientation=n.DEFAULTSIDE,r.overrideMaterialSideOrientation=null,r.ignoreCameraMaxZ=!1,i=r.getScene(),r._onBeforeDraw=function(e,t,n){e&&n&&(r._uniformBuffer?r.transferToEffect(t):n.bindOnlyWorldMatrix(t))},o){if(o._geometry&&o._geometry.applyToMesh((0,a.Z)(r)),g.j.DeepCopy(o,(0,a.Z)(r),["name","material","skeleton","instances","parent","uniqueId","source","metadata","morphTargetManager","hasInstances","worldMatrixInstancedBuffer","previousWorldMatrixInstancedBuffer","hasLODLevels","geometry","isBlocked","areNormalsFrozen","facetNb","isFacetDataEnabled","lightSources","useBones","isAnInstance","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","cloneMeshMap","hasBoundingInfo"],["_poseMatrix"]),r._internalMeshDataInfo._source=o,i.useClonedMeshMap&&(o._internalMeshDataInfo.meshMap||(o._internalMeshDataInfo.meshMap={}),o._internalMeshDataInfo.meshMap[r.uniqueId]=(0,a.Z)(r)),r._originalBuilderSideOrientation=o._originalBuilderSideOrientation,r._creationDataStorage=o._creationDataStorage,o._ranges){var c=o._ranges;for(var d in c)Object.prototype.hasOwnProperty.call(c,d)&&c[d]&&r.createAnimationRange(d,c[d].from,c[d].to)}if(o.metadata&&o.metadata.clone?r.metadata=o.metadata.clone():r.metadata=o.metadata,_.$&&_.$.HasTags(o)&&_.$.AddTagsTo((0,a.Z)(r),_.$.GetTags(o,!0)),r.setEnabled(o.isEnabled(!1)),r.parent=o.parent,r.setPivotMatrix(o.getPivotMatrix()),r.id=e+"."+o.id,r.material=o.material,!h)for(var v=o.getDescendants(!0),m=0;m<v.length;m++){var y=v[m];y.clone&&y.clone(e+"."+y.name,(0,a.Z)(r))}if(o.morphTargetManager&&(r.morphTargetManager=o.morphTargetManager),i.getPhysicsEngine){var I=i.getPhysicsEngine();if(l&&I){var p=I.getImpostorForPhysicsObject(o);p&&(r.physicsImpostor=p.clone((0,a.Z)(r)))}}for(var M=0;M<i.particleSystems.length;M++){var b=i.particleSystems[M];b.emitter===o&&b.clone(b.name,(0,a.Z)(r))}r.skeleton=o.skeleton,r.refreshBoundingInfo(!0,!0),r.computeWorldMatrix(!0)}return null!==s&&(r.parent=s),r._instanceDataStorage.hardwareInstancedRendering=r.getEngine().getCaps().instancedArrays,r._internalMeshDataInfo._onMeshReadyObserverAdded=function(e){e.unregisterOnNextCall=!0,r.isReady(!0)?r.onMeshReadyObservable.notifyObservers((0,a.Z)(r)):r._internalMeshDataInfo._checkReadinessObserver||(r._internalMeshDataInfo._checkReadinessObserver=r._scene.onBeforeRenderObservable.add((function(){r.isReady(!0)&&(r._scene.onBeforeRenderObservable.remove(r._internalMeshDataInfo._checkReadinessObserver),r._internalMeshDataInfo._checkReadinessObserver=null,r.onMeshReadyObservable.notifyObservers((0,a.Z)(r)))})))},r.onMeshReadyObservable=new f.y$(r._internalMeshDataInfo._onMeshReadyObserverAdded),o&&o.onClonedObservable.notifyObservers((0,a.Z)(r)),r}return(0,l.Z)(n,[{key:"useLODScreenCoverage",get:function(){return this._internalMeshDataInfo._useLODScreenCoverage},set:function(e){this._internalMeshDataInfo._useLODScreenCoverage=e}},{key:"computeBonesUsingShaders",get:function(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders},set:function(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(e&&this._internalMeshDataInfo._sourcePositions&&(this.setVerticesData(b.o.PositionKind,this._internalMeshDataInfo._sourcePositions,!0),this._internalMeshDataInfo._sourceNormals&&this.setVerticesData(b.o.NormalKind,this._internalMeshDataInfo._sourceNormals,!0),this._internalMeshDataInfo._sourcePositions=null,this._internalMeshDataInfo._sourceNormals=null),this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}},{key:"onBeforeRenderObservable",get:function(){return this._internalMeshDataInfo._onBeforeRenderObservable||(this._internalMeshDataInfo._onBeforeRenderObservable=new f.y$),this._internalMeshDataInfo._onBeforeRenderObservable}},{key:"onBeforeBindObservable",get:function(){return this._internalMeshDataInfo._onBeforeBindObservable||(this._internalMeshDataInfo._onBeforeBindObservable=new f.y$),this._internalMeshDataInfo._onBeforeBindObservable}},{key:"onAfterRenderObservable",get:function(){return this._internalMeshDataInfo._onAfterRenderObservable||(this._internalMeshDataInfo._onAfterRenderObservable=new f.y$),this._internalMeshDataInfo._onAfterRenderObservable}},{key:"onBetweenPassObservable",get:function(){return this._internalMeshDataInfo._onBetweenPassObservable||(this._internalMeshDataInfo._onBetweenPassObservable=new f.y$),this._internalMeshDataInfo._onBetweenPassObservable}},{key:"onBeforeDrawObservable",get:function(){return this._internalMeshDataInfo._onBeforeDrawObservable||(this._internalMeshDataInfo._onBeforeDrawObservable=new f.y$),this._internalMeshDataInfo._onBeforeDrawObservable}},{key:"onBeforeDraw",set:function(e){this._onBeforeDrawObserver&&this.onBeforeDrawObservable.remove(this._onBeforeDrawObserver),this._onBeforeDrawObserver=this.onBeforeDrawObservable.add(e)}},{key:"hasInstances",get:function(){return this.instances.length>0}},{key:"hasThinInstances",get:function(){var e;return(null!==(e=this._thinInstanceDataStorage.instancesCount)&&void 0!==e?e:0)>0}},{key:"forcedInstanceCount",get:function(){return this._internalMeshDataInfo._forcedInstanceCount},set:function(e){this._internalMeshDataInfo._forcedInstanceCount=e}},{key:"source",get:function(){return this._internalMeshDataInfo._source}},{key:"cloneMeshMap",get:function(){return this._internalMeshDataInfo.meshMap}},{key:"isUnIndexed",get:function(){return this._unIndexed},set:function(e){this._unIndexed!==e&&(this._unIndexed=e,this._markSubMeshesAsAttributesDirty())}},{key:"worldMatrixInstancedBuffer",get:function(){return this._instanceDataStorage.instancesData}},{key:"previousWorldMatrixInstancedBuffer",get:function(){return this._instanceDataStorage.instancesPreviousData}},{key:"manualUpdateOfWorldMatrixInstancedBuffer",get:function(){return this._instanceDataStorage.manualUpdate},set:function(e){this._instanceDataStorage.manualUpdate=e}},{key:"manualUpdateOfPreviousWorldMatrixInstancedBuffer",get:function(){return this._instanceDataStorage.previousManualUpdate},set:function(e){this._instanceDataStorage.previousManualUpdate=e}},{key:"instantiateHierarchy",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0,r=0===this.getTotalVertices()||t&&t.doNotInstantiate&&(!0===t.doNotInstantiate||t.doNotInstantiate(this))?this.clone("Clone of "+(this.name||this.id),e||this.parent,!0):this.createInstance("instance of "+(this.name||this.id));r.parent=e||this.parent,r.position=this.position.clone(),r.scaling=this.scaling.clone(),this.rotationQuaternion?r.rotationQuaternion=this.rotationQuaternion.clone():r.rotation=this.rotation.clone(),n&&n(this,r);var a,i=R(this.getChildTransformNodes(!0));try{for(i.s();!(a=i.n()).done;){var s=a.value;"InstancedMesh"===s.getClassName()&&"Mesh"===r.getClassName()?s.instantiateHierarchy(r,{doNotInstantiate:t&&t.doNotInstantiate||!1,newSourcedMesh:r},n):s.instantiateHierarchy(r,t,n)}}catch(o){i.e(o)}finally{i.f()}return r}},{key:"getClassName",value:function(){return"Mesh"}},{key:"_isMesh",get:function(){return!0}},{key:"toString",value:function(e){var t=(0,i.Z)((0,h.Z)(n.prototype),"toString",this).call(this,e);if(t+=", n vertices: "+this.getTotalVertices(),t+=", parent: "+(this._waitingParentId?this._waitingParentId:this.parent?this.parent.name:"NONE"),this.animations)for(var r=0;r<this.animations.length;r++)t+=", animation[0]: "+this.animations[r].toString(e);if(e)if(this._geometry){var a=this.getIndices(),s=this.getVerticesData(b.o.PositionKind);s&&a&&(t+=", flat shading: "+(s.length/3===a.length?"YES":"NO"))}else t+=", flat shading: UNKNOWN";return t}},{key:"_unBindEffect",value:function(){(0,i.Z)((0,h.Z)(n.prototype),"_unBindEffect",this).call(this);var e,t=R(this.instances);try{for(t.s();!(e=t.n()).done;){e.value._unBindEffect()}}catch(r){t.e(r)}finally{t.f()}}},{key:"hasLODLevels",get:function(){return this._internalMeshDataInfo._LODLevels.length>0}},{key:"getLODLevels",value:function(){return this._internalMeshDataInfo._LODLevels}},{key:"_sortLODLevels",value:function(){var e=this._internalMeshDataInfo._useLODScreenCoverage?-1:1;this._internalMeshDataInfo._LODLevels.sort((function(t,n){return t.distanceOrScreenCoverage<n.distanceOrScreenCoverage?e:t.distanceOrScreenCoverage>n.distanceOrScreenCoverage?-e:0}))}},{key:"addLODLevel",value:function(e,t){if(t&&t._masterMesh)return C.Y.Warn("You cannot use a mesh as LOD level twice"),this;var n=new V.g(e,t);return this._internalMeshDataInfo._LODLevels.push(n),t&&(t._masterMesh=this),this._sortLODLevels(),this}},{key:"getLODLevelAtDistance",value:function(e){for(var t=this._internalMeshDataInfo,n=0;n<t._LODLevels.length;n++){var r=t._LODLevels[n];if(r.distanceOrScreenCoverage===e)return r.mesh}return null}},{key:"removeLODLevel",value:function(e){for(var t=this._internalMeshDataInfo,n=0;n<t._LODLevels.length;n++)t._LODLevels[n].mesh===e&&(t._LODLevels.splice(n,1),e&&(e._masterMesh=null));return this._sortLODLevels(),this}},{key:"getLOD",value:function(e,t){var n,r=this._internalMeshDataInfo;if(!r._LODLevels||0===r._LODLevels.length)return this;t?n=t:n=this.getBoundingInfo().boundingSphere;var a=n.centerWorld.subtract(e.globalPosition).length(),i=a,s=1;if(r._useLODScreenCoverage){var o=e.screenArea,h=n.radiusWorld*e.minZ/a;i=(h=h*h*Math.PI)/o,s=-1}if(s*r._LODLevels[r._LODLevels.length-1].distanceOrScreenCoverage>s*i)return this.onLODLevelSelection&&this.onLODLevelSelection(i,this,this),this;for(var l=0;l<r._LODLevels.length;l++){var u=r._LODLevels[l];if(s*u.distanceOrScreenCoverage<s*i){if(u.mesh){if(4===u.mesh.delayLoadState)return u.mesh._checkDelayState(),this;if(2===u.mesh.delayLoadState)return this;u.mesh._preActivate(),u.mesh._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)}return this.onLODLevelSelection&&this.onLODLevelSelection(i,this,u.mesh),u.mesh}}return this.onLODLevelSelection&&this.onLODLevelSelection(i,this,this),this}},{key:"geometry",get:function(){return this._geometry}},{key:"getTotalVertices",value:function(){return null===this._geometry||void 0===this._geometry?0:this._geometry.getTotalVertices()}},{key:"getVerticesData",value:function(e,t,n){var r,a;if(!this._geometry)return null;var i=null===(r=this._userInstancedBuffersStorage)||void 0===r||null===(a=r.vertexBuffers[e])||void 0===a?void 0:a.getFloatData(this._geometry.getTotalVertices(),n||t&&1!==this._geometry.meshes.length);return i||(i=this._geometry.getVerticesData(e,t,n)),i}},{key:"getVertexBuffer",value:function(e){var t,n;return this._geometry?null!==(t=null===(n=this._userInstancedBuffersStorage)||void 0===n?void 0:n.vertexBuffers[e])&&void 0!==t?t:this._geometry.getVertexBuffer(e):null}},{key:"isVerticesDataPresent",value:function(e){var t;return this._geometry?void 0!==(null===(t=this._userInstancedBuffersStorage)||void 0===t?void 0:t.vertexBuffers[e])||this._geometry.isVerticesDataPresent(e):!!this._delayInfo&&-1!==this._delayInfo.indexOf(e)}},{key:"isVertexBufferUpdatable",value:function(e){var t,n;return this._geometry?(null===(t=this._userInstancedBuffersStorage)||void 0===t||null===(n=t.vertexBuffers[e])||void 0===n?void 0:n.isUpdatable())||this._geometry.isVertexBufferUpdatable(e):!!this._delayInfo&&-1!==this._delayInfo.indexOf(e)}},{key:"getVerticesDataKinds",value:function(){if(!this._geometry){var e=new Array;return this._delayInfo&&this._delayInfo.forEach((function(t){e.push(t)})),e}var t=this._geometry.getVerticesDataKinds();if(this._userInstancedBuffersStorage)for(var n in this._userInstancedBuffersStorage.vertexBuffers)t.push(n);return t}},{key:"getTotalIndices",value:function(){return this._geometry?this._geometry.getTotalIndices():0}},{key:"getIndices",value:function(e,t){return this._geometry?this._geometry.getIndices(e,t):[]}},{key:"isBlocked",get:function(){return null!==this._masterMesh&&void 0!==this._masterMesh}},{key:"isReady",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(2===this.delayLoadState)return!1;if(!(0,i.Z)((0,h.Z)(n.prototype),"isReady",this).call(this,e))return!1;if(!this.subMeshes||0===this.subMeshes.length)return!0;if(!e)return!0;var r=this.getEngine(),a=this.getScene(),s=t||r.getCaps().instancedArrays&&(this.instances.length>0||this.hasThinInstances);this.computeWorldMatrix();var o=this.material||a.defaultMaterial;if(o)if(o._storeEffectOnSubMeshes){var l,u=R(this.subMeshes);try{for(u.s();!(l=u.n()).done;){var c=l.value,d=c.getMaterial();if(d)if(d._storeEffectOnSubMeshes){if(!d.isReadyForSubMesh(this,c,s))return!1}else if(!d.isReady(this,s))return!1}}catch(w){u.e(w)}finally{u.f()}}else if(!o.isReady(this,s))return!1;var f,v=r.currentRenderPassId,g=R(this.lightSources);try{for(g.s();!(f=g.n()).done;){var _,m,y,I,p=f.value,M=p.getShadowGenerator();if(M&&(null===(_=M.getShadowMap())||void 0===_||!_.renderList||null!==(m=M.getShadowMap())&&void 0!==m&&m.renderList&&-1!==(null===(y=M.getShadowMap())||void 0===y||null===(I=y.renderList)||void 0===I?void 0:I.indexOf(this)))){M.getShadowMap()&&(r.currentRenderPassId=M.getShadowMap().renderPassId);var b,D=R(this.subMeshes);try{for(D.s();!(b=D.n()).done;){var S,x,B=b.value;if(!M.isReady(B,s,null!==(S=null===(x=B.getMaterial())||void 0===x?void 0:x.needAlphaBlendingForMesh(this))&&void 0!==S&&S))return r.currentRenderPassId=v,!1}}catch(w){D.e(w)}finally{D.f()}r.currentRenderPassId=v}}}catch(w){g.e(w)}finally{g.f()}var A,k=R(this._internalMeshDataInfo._LODLevels);try{for(k.s();!(A=k.n()).done;){var P=A.value;if(P.mesh&&!P.mesh.isReady(s))return!1}}catch(w){k.e(w)}finally{k.f()}return!0}},{key:"areNormalsFrozen",get:function(){return this._internalMeshDataInfo._areNormalsFrozen}},{key:"freezeNormals",value:function(){return this._internalMeshDataInfo._areNormalsFrozen=!0,this}},{key:"unfreezeNormals",value:function(){return this._internalMeshDataInfo._areNormalsFrozen=!1,this}},{key:"overridenInstanceCount",set:function(e){this._instanceDataStorage.overridenInstanceCount=e}},{key:"_preActivate",value:function(){var e=this._internalMeshDataInfo,t=this.getScene().getRenderId();return e._preActivateId===t||(e._preActivateId=t,this._instanceDataStorage.visibleInstances=null),this}},{key:"_preActivateForIntermediateRendering",value:function(e){return this._instanceDataStorage.visibleInstances&&(this._instanceDataStorage.visibleInstances.intermediateDefaultRenderId=e),this}},{key:"_registerInstanceForRenderId",value:function(e,t){return this._instanceDataStorage.visibleInstances||(this._instanceDataStorage.visibleInstances={defaultRenderId:t,selfDefaultRenderId:this._renderId}),this._instanceDataStorage.visibleInstances[t]||(void 0!==this._instanceDataStorage.previousRenderId&&this._instanceDataStorage.isFrozen&&(this._instanceDataStorage.visibleInstances[this._instanceDataStorage.previousRenderId]=null),this._instanceDataStorage.previousRenderId=t,this._instanceDataStorage.visibleInstances[t]=new Array),this._instanceDataStorage.visibleInstances[t].push(e),this}},{key:"_afterComputeWorldMatrix",value:function(){(0,i.Z)((0,h.Z)(n.prototype),"_afterComputeWorldMatrix",this).call(this),this.hasThinInstances&&(this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1))}},{key:"_postActivate",value:function(){this.edgesShareWithInstances&&this.edgesRenderer&&this.edgesRenderer.isEnabled&&this._renderingGroup&&(this._renderingGroup._edgesRenderers.pushNoDuplicate(this.edgesRenderer),this.edgesRenderer.customInstances.push(this.getWorldMatrix()))}},{key:"refreshBoundingInfo",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;var n=this.geometry?this.geometry.boundingBias:null;return this._refreshBoundingInfo(this._getPositionData(e,t),n),this}},{key:"_createGlobalSubMesh",value:function(e){var t=this.getTotalVertices();if(!t||!this.getIndices())return null;if(this.subMeshes&&this.subMeshes.length>0){var n=this.getIndices();if(!n)return null;var r=n.length,a=!1;if(e)a=!0;else{var i,s=R(this.subMeshes);try{for(s.s();!(i=s.n()).done;){var o=i.value;if(o.indexStart+o.indexCount>r){a=!0;break}if(o.verticesStart+o.verticesCount>t){a=!0;break}}}catch(h){s.e(h)}finally{s.f()}}if(!a)return this.subMeshes[0]}return this.releaseSubMeshes(),new B.P(0,0,t,0,this.getTotalIndices(),this)}},{key:"subdivide",value:function(e){if(!(e<1)){for(var t=this.getTotalIndices(),n=t/e|0,r=0;n%3!=0;)n++;this.releaseSubMeshes();for(var a=0;a<e&&!(r>=t);a++)B.P.CreateFromIndices(0,r,a===e-1?t-r:n,this),r+=n;this.synchronizeInstances()}}},{key:"setVerticesData",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3?arguments[3]:void 0;if(this._geometry)this._geometry.setVerticesData(e,t,n,r);else{var a=new D.x;a.set(t,e);var i=this.getScene();new S.Z(S.Z.RandomId(),i,a,n,this)}return this}},{key:"removeVerticesData",value:function(e){this._geometry&&this._geometry.removeVerticesData(e)}},{key:"markVerticesDataAsUpdatable",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=this.getVertexBuffer(e);n&&n.isUpdatable()!==t&&this.setVerticesData(e,this.getVerticesData(e),t)}},{key:"setVerticesBuffer",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return this._geometry||(this._geometry=S.Z.CreateGeometryForMesh(this)),this._geometry.setVerticesBuffer(e,null,t),this}},{key:"updateVerticesData",value:function(e,t,n,r){return this._geometry?(r?(this.makeGeometryUnique(),this.updateVerticesData(e,t,n,!1)):this._geometry.updateVerticesData(e,t,n),this):this}},{key:"updateMeshPositions",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=this.getVerticesData(b.o.PositionKind);if(!n)return this;if(e(n),this.updateVerticesData(b.o.PositionKind,n,!1,!1),t){var r=this.getIndices(),a=this.getVerticesData(b.o.NormalKind);if(!a)return this;D.x.ComputeNormals(n,r,a),this.updateVerticesData(b.o.NormalKind,a,!1,!1)}return this}},{key:"makeGeometryUnique",value:function(){if(!this._geometry)return this;if(1===this._geometry.meshes.length)return this;var e=this._geometry,t=this._geometry.copy(S.Z.RandomId());return e.releaseForMesh(this,!0),t.applyToMesh(this),this}},{key:"setIndices",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this._geometry)this._geometry.setIndices(e,t,n);else{var r=new D.x;r.indices=e;var a=this.getScene();new S.Z(S.Z.RandomId(),a,r,n,this)}return this}},{key:"updateIndices",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return this._geometry?(this._geometry.updateIndices(e,t,n),this):this}},{key:"toLeftHanded",value:function(){return this._geometry?(this._geometry.toLeftHanded(),this):this}},{key:"_bind",value:function(e,t,n){if(!this._geometry)return this;var r,a=this.getScene().getEngine();if(this.morphTargetManager&&this.morphTargetManager.isUsingTextureForTargets&&this.morphTargetManager._bind(t),this._unIndexed)r=null;else switch(n){case A.F.PointFillMode:r=null;break;case A.F.WireFrameFillMode:r=e._getLinesIndexBuffer(this.getIndices(),a);break;default:case A.F.TriangleFillMode:r=this._geometry.getIndexBuffer()}return!this._userInstancedBuffersStorage||this.hasThinInstances?this._geometry._bind(t,r):this._geometry._bind(t,r,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects),this}},{key:"_draw",value:function(e,t,n){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;this._internalMeshDataInfo._onBeforeDrawObservable&&this._internalMeshDataInfo._onBeforeDrawObservable.notifyObservers(this);var r=this.getScene().getEngine();return this._unIndexed||t==A.F.PointFillMode?r.drawArraysType(t,e.verticesStart,e.verticesCount,this.forcedInstanceCount||n):t==A.F.WireFrameFillMode?r.drawElementsType(t,0,e._linesIndexCount,this.forcedInstanceCount||n):r.drawElementsType(t,e.indexStart,e.indexCount,this.forcedInstanceCount||n),this}},{key:"registerBeforeRender",value:function(e){return this.onBeforeRenderObservable.add(e),this}},{key:"unregisterBeforeRender",value:function(e){return this.onBeforeRenderObservable.removeCallback(e),this}},{key:"registerAfterRender",value:function(e){return this.onAfterRenderObservable.add(e),this}},{key:"unregisterAfterRender",value:function(e){return this.onAfterRenderObservable.removeCallback(e),this}},{key:"_getInstancesRenderList",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._instanceDataStorage.isFrozen){if(t)return this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.hardwareInstancedRendering[e]=!1,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.renderSelf[e]=!0,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode;if(this._instanceDataStorage.previousBatch)return this._instanceDataStorage.previousBatch}var n=this.getScene(),r=n._isInIntermediateRendering(),a=r?this._internalAbstractMeshDataInfo._onlyForInstancesIntermediate:this._internalAbstractMeshDataInfo._onlyForInstances,i=this._instanceDataStorage.batchCache;if(i.mustReturn=!1,i.renderSelf[e]=t||!a&&this.isEnabled()&&this.isVisible,i.visibleInstances[e]=null,this._instanceDataStorage.visibleInstances&&!t){var s=this._instanceDataStorage.visibleInstances,o=n.getRenderId(),h=r?s.intermediateDefaultRenderId:s.defaultRenderId;i.visibleInstances[e]=s[o],!i.visibleInstances[e]&&h&&(i.visibleInstances[e]=s[h])}return i.hardwareInstancedRendering[e]=!t&&this._instanceDataStorage.hardwareInstancedRendering&&null!==i.visibleInstances[e]&&void 0!==i.visibleInstances[e],this._instanceDataStorage.previousBatch=i,i}},{key:"_renderWithInstances",value:function(e,t,r,a,i){var s=r.visibleInstances[e._id];if(!s)return this;for(var o=this._instanceDataStorage,h=o.instancesBufferSize,l=o.instancesBuffer,u=o.instancesPreviousBuffer,c=16*(s.length+1)*4;o.instancesBufferSize<c;)o.instancesBufferSize*=2;o.instancesData&&h==o.instancesBufferSize||(o.instancesData=new Float32Array(o.instancesBufferSize/4)),(this._scene.needsPreviousWorldMatrices&&!o.instancesPreviousData||h!=o.instancesBufferSize)&&(o.instancesPreviousData=new Float32Array(o.instancesBufferSize/4));var d=0,f=0,v=r.renderSelf[e._id],g=!l||h!==o.instancesBufferSize||this._scene.needsPreviousWorldMatrices&&!o.instancesPreviousBuffer;if(this._instanceDataStorage.manualUpdate||o.isFrozen&&!g)f=(v?1:0)+s.length;else{var _=this.getWorldMatrix();if(v&&(this._scene.needsPreviousWorldMatrices&&(o.masterMeshPreviousWorldMatrix?(o.masterMeshPreviousWorldMatrix.copyToArray(o.instancesPreviousData,d),o.masterMeshPreviousWorldMatrix.copyFrom(_)):(o.masterMeshPreviousWorldMatrix=_.clone(),o.masterMeshPreviousWorldMatrix.copyToArray(o.instancesPreviousData,d))),_.copyToArray(o.instancesData,d),d+=16,f++),s){var m;if(n.INSTANCEDMESH_SORT_TRANSPARENT&&this._scene.activeCamera&&null!==(m=e.getMaterial())&&void 0!==m&&m.needAlphaBlendingForMesh(e.getRenderingMesh())){for(var y=this._scene.activeCamera.globalPosition,p=0;p<s.length;p++){var M=s[p];M._distanceToCamera=I.P.Distance(M.getBoundingInfo().boundingSphere.centerWorld,y)}s.sort((function(e,t){return e._distanceToCamera>t._distanceToCamera?-1:e._distanceToCamera<t._distanceToCamera?1:0}))}for(var D=0;D<s.length;D++){var S=s[D],x=S.getWorldMatrix();x.copyToArray(o.instancesData,d),this._scene.needsPreviousWorldMatrices&&(S._previousWorldMatrix?(S._previousWorldMatrix.copyToArray(o.instancesPreviousData,d),S._previousWorldMatrix.copyFrom(x)):(S._previousWorldMatrix=x.clone(),S._previousWorldMatrix.copyToArray(o.instancesPreviousData,d))),d+=16,f++}}}return g?(l&&l.dispose(),u&&u.dispose(),l=new b.l(i,o.instancesData,!0,16,!1,!0),o.instancesBuffer=l,this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this._userInstancedBuffersStorage.vertexBuffers.world0=l.createVertexBuffer("world0",0,4),this._userInstancedBuffersStorage.vertexBuffers.world1=l.createVertexBuffer("world1",4,4),this._userInstancedBuffersStorage.vertexBuffers.world2=l.createVertexBuffer("world2",8,4),this._userInstancedBuffersStorage.vertexBuffers.world3=l.createVertexBuffer("world3",12,4),this._scene.needsPreviousWorldMatrices&&(u=new b.l(i,o.instancesPreviousData,!0,16,!1,!0),o.instancesPreviousBuffer=u,this._userInstancedBuffersStorage.vertexBuffers.previousWorld0=u.createVertexBuffer("previousWorld0",0,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld1=u.createVertexBuffer("previousWorld1",4,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld2=u.createVertexBuffer("previousWorld2",8,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld3=u.createVertexBuffer("previousWorld3",12,4)),this._invalidateInstanceVertexArrayObject()):this._instanceDataStorage.isFrozen||(l.updateDirectly(o.instancesData,0,f),!this._scene.needsPreviousWorldMatrices||this._instanceDataStorage.manualUpdate&&!this._instanceDataStorage.previousManualUpdate||u.updateDirectly(o.instancesPreviousData,0,f)),this._processInstancedBuffers(s,v),this.getScene()._activeIndices.addCount(e.indexCount*f,!1),i._currentDrawContext&&(i._currentDrawContext.useInstancing=!0),this._bind(e,a,t),this._draw(e,t,f),!this._scene.needsPreviousWorldMatrices||g||!this._instanceDataStorage.manualUpdate||this._instanceDataStorage.isFrozen||this._instanceDataStorage.previousManualUpdate||u.updateDirectly(o.instancesData,0,f),i.unbindInstanceAttributes(),this}},{key:"_renderWithThinInstances",value:function(e,t,n,r){var a,i,s=null!==(a=null===(i=this._thinInstanceDataStorage)||void 0===i?void 0:i.instancesCount)&&void 0!==a?a:0;this.getScene()._activeIndices.addCount(e.indexCount*s,!1),r._currentDrawContext&&(r._currentDrawContext.useInstancing=!0),this._bind(e,n,t),this._draw(e,t,s),this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&this._thinInstanceDataStorage.matrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?this._thinInstanceDataStorage.previousMatrixBuffer.updateDirectly(this._thinInstanceDataStorage.matrixData,0,s):this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.matrixData,!1)),r.unbindInstanceAttributes()}},{key:"_processInstancedBuffers",value:function(e,t){}},{key:"_processRendering",value:function(e,t,n,r,a,i,s,o){var h=this.getScene(),l=h.getEngine();if(i&&t.getRenderingMesh().hasThinInstances)return this._renderWithThinInstances(t,r,n,l),this;if(i)this._renderWithInstances(t,r,a,n,l);else{l._currentDrawContext&&(l._currentDrawContext.useInstancing=!1);var u=0;a.renderSelf[t._id]&&(s&&s(!1,e.getWorldMatrix(),o),u++,this._draw(t,r,this._instanceDataStorage.overridenInstanceCount));var c=a.visibleInstances[t._id];if(c){var d=c.length;u+=d;for(var f=0;f<d;f++){var v=c[f].getWorldMatrix();s&&s(!0,v,o),this._draw(t,r)}}h._activeIndices.addCount(t.indexCount*u,!1)}return this}},{key:"_rebuild",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._instanceDataStorage.instancesBuffer&&(e&&this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null),this._userInstancedBuffersStorage){for(var t in this._userInstancedBuffersStorage.vertexBuffers){var r=this._userInstancedBuffersStorage.vertexBuffers[t];r&&(e&&r.dispose(),this._userInstancedBuffersStorage.vertexBuffers[t]=null)}this._userInstancedBuffersStorage.vertexArrayObjects&&(this._userInstancedBuffersStorage.vertexArrayObjects={})}this._internalMeshDataInfo._effectiveMaterial=null,(0,i.Z)((0,h.Z)(n.prototype),"_rebuild",this).call(this,e)}},{key:"_freeze",value:function(){if(this.subMeshes){for(var e=0;e<this.subMeshes.length;e++)this._getInstancesRenderList(e);this._internalMeshDataInfo._effectiveMaterial=null,this._instanceDataStorage.isFrozen=!0}}},{key:"_unFreeze",value:function(){this._instanceDataStorage.isFrozen=!1,this._instanceDataStorage.previousBatch=null}},{key:"render",value:function(e,t,n){var r,a,i,s,o=this.getScene();if(this._internalAbstractMeshDataInfo._isActiveIntermediate?this._internalAbstractMeshDataInfo._isActiveIntermediate=!1:this._internalAbstractMeshDataInfo._isActive=!1,this._checkOcclusionQuery()&&!this._occlusionDataStorage.forceRenderingWhenOccluded)return this;var h=this._getInstancesRenderList(e._id,!!n);if(h.mustReturn)return this;if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;var l=o.getEngine(),u=0,c=null;this.ignoreCameraMaxZ&&o.activeCamera&&!o._isInIntermediateRendering()&&(u=o.activeCamera.maxZ,c=o.activeCamera,o.activeCamera.maxZ=0,o.updateTransformMatrix(!0)),this._internalMeshDataInfo._onBeforeRenderObservable&&this._internalMeshDataInfo._onBeforeRenderObservable.notifyObservers(this);var d,f=h.hardwareInstancedRendering[e._id]||e.getRenderingMesh().hasThinInstances,v=this._instanceDataStorage,g=e.getMaterial();if(!g)return c&&(c.maxZ=u,o.updateTransformMatrix(!0)),this;if(v.isFrozen&&this._internalMeshDataInfo._effectiveMaterial&&this._internalMeshDataInfo._effectiveMaterial===g){if(g._storeEffectOnSubMeshes&&(null===(r=e.effect)||void 0===r||!r._wasPreviouslyReady)||!g._storeEffectOnSubMeshes&&(null===(a=g.getEffect())||void 0===a||!a._wasPreviouslyReady))return c&&(c.maxZ=u,o.updateTransformMatrix(!0)),this}else{if(g._storeEffectOnSubMeshes){if(!g.isReadyForSubMesh(this,e,f))return c&&(c.maxZ=u,o.updateTransformMatrix(!0)),this}else if(!g.isReady(this,f))return c&&(c.maxZ=u,o.updateTransformMatrix(!0)),this;this._internalMeshDataInfo._effectiveMaterial=g}t&&l.setAlphaMode(this._internalMeshDataInfo._effectiveMaterial.alphaMode);var _,m=null!==(i=null===(s=d=this._internalMeshDataInfo._effectiveMaterial._storeEffectOnSubMeshes?e._drawWrapper:this._internalMeshDataInfo._effectiveMaterial._getDrawWrapper())||void 0===s?void 0:s.effect)&&void 0!==i?i:null,I=R(o._beforeRenderingMeshStage);try{for(I.s();!(_=I.n()).done;){_.value.action(this,e,h,m)}}catch(w){I.e(w)}finally{I.f()}if(!d||!m)return c&&(c.maxZ=u,o.updateTransformMatrix(!0)),this;var p,M=n||this;if(v.isFrozen||!this._internalMeshDataInfo._effectiveMaterial.backFaceCulling&&null===this.overrideMaterialSideOrientation)p=v.sideOrientation;else{var b=M._getWorldMatrixDeterminant();null==(p=this.overrideMaterialSideOrientation)&&(p=this._internalMeshDataInfo._effectiveMaterial.sideOrientation),b<0&&(p=p===A.F.ClockWiseSideOrientation?A.F.CounterClockWiseSideOrientation:A.F.ClockWiseSideOrientation),v.sideOrientation=p}var D=this._internalMeshDataInfo._effectiveMaterial._preBind(d,p);this._internalMeshDataInfo._effectiveMaterial.forceDepthWrite&&l.setDepthWrite(!0);var S=o.forcePointsCloud?A.F.PointFillMode:o.forceWireframe?A.F.WireFrameFillMode:this._internalMeshDataInfo._effectiveMaterial.fillMode;this._internalMeshDataInfo._onBeforeBindObservable&&this._internalMeshDataInfo._onBeforeBindObservable.notifyObservers(this),f||this._bind(e,m,S);var x=this._internalMeshDataInfo._effectiveMaterial,B=M.getWorldMatrix();x._storeEffectOnSubMeshes?x.bindForSubMesh(B,this,e):x.bind(B,this),!x.backFaceCulling&&x.separateCullingPass&&(l.setState(!0,x.zOffset,!1,!D,x.cullBackFaces,x.stencil,x.zOffsetUnits),this._processRendering(this,e,m,S,h,f,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),l.setState(!0,x.zOffset,!1,D,x.cullBackFaces,x.stencil,x.zOffsetUnits),this._internalMeshDataInfo._onBetweenPassObservable&&this._internalMeshDataInfo._onBetweenPassObservable.notifyObservers(e)),this._processRendering(this,e,m,S,h,f,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),this._internalMeshDataInfo._effectiveMaterial.unbind();var k,P=R(o._afterRenderingMeshStage);try{for(P.s();!(k=P.n()).done;){k.value.action(this,e,h,m)}}catch(w){P.e(w)}finally{P.f()}return this._internalMeshDataInfo._onAfterRenderObservable&&this._internalMeshDataInfo._onAfterRenderObservable.notifyObservers(this),c&&(c.maxZ=u,o.updateTransformMatrix(!0)),o.performancePriority!==y.a.Aggressive||v.isFrozen||this._freeze(),this}},{key:"cleanMatrixWeights",value:function(){this.isVerticesDataPresent(b.o.MatricesWeightsKind)&&(this.isVerticesDataPresent(b.o.MatricesWeightsExtraKind)?this._normalizeSkinWeightsAndExtra():this._normalizeSkinFourWeights())}},{key:"_normalizeSkinFourWeights",value:function(){for(var e=this.getVerticesData(b.o.MatricesWeightsKind),t=e.length,n=0;n<t;n+=4){var r=e[n]+e[n+1]+e[n+2]+e[n+3];if(0===r)e[n]=1;else{var a=1/r;e[n]*=a,e[n+1]*=a,e[n+2]*=a,e[n+3]*=a}}this.setVerticesData(b.o.MatricesWeightsKind,e)}},{key:"_normalizeSkinWeightsAndExtra",value:function(){for(var e=this.getVerticesData(b.o.MatricesWeightsExtraKind),t=this.getVerticesData(b.o.MatricesWeightsKind),n=t.length,r=0;r<n;r+=4){var a=t[r]+t[r+1]+t[r+2]+t[r+3];if(0===(a+=e[r]+e[r+1]+e[r+2]+e[r+3]))t[r]=1;else{var i=1/a;t[r]*=i,t[r+1]*=i,t[r+2]*=i,t[r+3]*=i,e[r]*=i,e[r+1]*=i,e[r+2]*=i,e[r+3]*=i}}this.setVerticesData(b.o.MatricesWeightsKind,t),this.setVerticesData(b.o.MatricesWeightsKind,e)}},{key:"validateSkinning",value:function(){var e=this.getVerticesData(b.o.MatricesWeightsExtraKind),t=this.getVerticesData(b.o.MatricesWeightsKind);if(null===t||null==this.skeleton)return{skinned:!1,valid:!0,report:"not skinned"};for(var n=t.length,r=0,a=0,i=0,s=0,o=null===e?4:8,h=new Array,l=0;l<=o;l++)h[l]=0;for(var u=0;u<n;u+=4){for(var c=t[u],d=c,f=0===d?0:1,v=1;v<o;v++){var g=v<4?t[u+v]:e[u+v-4];g>c&&r++,0!==g&&f++,d+=g,c=g}if(h[f]++,f>i&&(i=f),0===d)a++;else{for(var _=1/d,m=0,y=0;y<o;y++)m+=y<4?Math.abs(t[u+y]-t[u+y]*_):Math.abs(e[u+y-4]-e[u+y-4]*_);m>.001&&s++}}for(var I=this.skeleton.bones.length,p=this.getVerticesData(b.o.MatricesIndicesKind),M=this.getVerticesData(b.o.MatricesIndicesExtraKind),D=0,S=0;S<n;S+=4)for(var x=0;x<o;x++){var B=x<4?p[S+x]:M[S+x-4];(B>=I||B<0)&&D++}return{skinned:!0,valid:0===a&&0===s&&0===D,report:"Number of Weights = "+n/4+"\nMaximum influences = "+i+"\nMissing Weights = "+a+"\nNot Sorted = "+r+"\nNot Normalized = "+s+"\nWeightCounts = ["+h+"]\nNumber of bones = "+I+"\nBad Bone Indices = "+D}}},{key:"_checkDelayState",value:function(){var e=this.getScene();return this._geometry?this._geometry.load(e):4===this.delayLoadState&&(this.delayLoadState=2,this._queueLoad(e)),this}},{key:"_queueLoad",value:function(e){var t=this;e.addPendingData(this);var n=-1!==this.delayLoadingFile.indexOf(".babylonbinarymeshdata");return v.w1.LoadFile(this.delayLoadingFile,(function(n){n instanceof ArrayBuffer?t._delayLoadingFunction(n,t):t._delayLoadingFunction(JSON.parse(n),t),t.instances.forEach((function(e){e.refreshBoundingInfo(),e._syncSubMeshes()})),t.delayLoadState=1,e.removePendingData(t)}),(function(){}),e.offlineProvider,n),this}},{key:"isInFrustum",value:function(e){return 2!==this.delayLoadState&&(!!(0,i.Z)((0,h.Z)(n.prototype),"isInFrustum",this).call(this,e)&&(this._checkDelayState(),!0))}},{key:"setMaterialById",value:function(e){var t,n=this.getScene().materials;for(t=n.length-1;t>-1;t--)if(n[t].id===e)return this.material=n[t],this;var r=this.getScene().multiMaterials;for(t=r.length-1;t>-1;t--)if(r[t].id===e)return this.material=r[t],this;return this}},{key:"getAnimatables",value:function(){var e=new Array;return this.material&&e.push(this.material),this.skeleton&&e.push(this.skeleton),e}},{key:"bakeTransformIntoVertices",value:function(e){if(!this.isVerticesDataPresent(b.o.PositionKind))return this;var t=this.subMeshes.splice(0);this._resetPointsArrayCache();var n,r=this.getVerticesData(b.o.PositionKind),a=new Array;for(n=0;n<r.length;n+=3)I.P.TransformCoordinates(I.P.FromArray(r,n),e).toArray(a,n);if(this.setVerticesData(b.o.PositionKind,a,this.getVertexBuffer(b.o.PositionKind).isUpdatable()),this.isVerticesDataPresent(b.o.NormalKind)){for(r=this.getVerticesData(b.o.NormalKind),a=[],n=0;n<r.length;n+=3)I.P.TransformNormal(I.P.FromArray(r,n),e).normalize().toArray(a,n);this.setVerticesData(b.o.NormalKind,a,this.getVertexBuffer(b.o.NormalKind).isUpdatable())}return e.determinant()<0&&this.flipFaces(),this.releaseSubMeshes(),this.subMeshes=t,this}},{key:"bakeCurrentTransformIntoVertices",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return this.bakeTransformIntoVertices(this.computeWorldMatrix(!0)),this.resetLocalMatrix(e),this}},{key:"_positions",get:function(){return this._internalAbstractMeshDataInfo._positions?this._internalAbstractMeshDataInfo._positions:this._geometry?this._geometry._positions:null}},{key:"_resetPointsArrayCache",value:function(){return this._geometry&&this._geometry._resetPointsArrayCache(),this}},{key:"_generatePointsArray",value:function(){return!!this._geometry&&this._geometry._generatePointsArray()}},{key:"clone",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2?arguments[2]:void 0,a=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];return new n(e,this.getScene(),t,this,r,a)}},{key:"dispose",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.morphTargetManager=null,this._geometry&&this._geometry.releaseForMesh(this,!0);var r=this._internalMeshDataInfo;if(r._onBeforeDrawObservable&&r._onBeforeDrawObservable.clear(),r._onBeforeBindObservable&&r._onBeforeBindObservable.clear(),r._onBeforeRenderObservable&&r._onBeforeRenderObservable.clear(),r._onAfterRenderObservable&&r._onAfterRenderObservable.clear(),r._onBetweenPassObservable&&r._onBetweenPassObservable.clear(),this._scene.useClonedMeshMap){if(r.meshMap)for(var a in r.meshMap){var s=r.meshMap[a];s&&(s._internalMeshDataInfo._source=null,r.meshMap[a]=void 0)}r._source&&r._source._internalMeshDataInfo.meshMap&&(r._source._internalMeshDataInfo.meshMap[this.uniqueId]=void 0)}else{var o,l=this.getScene().meshes,u=R(l);try{for(u.s();!(o=u.n()).done;){var c=o.value,d=c;d._internalMeshDataInfo&&d._internalMeshDataInfo._source&&d._internalMeshDataInfo._source===this&&(d._internalMeshDataInfo._source=null)}}catch(f){u.e(f)}finally{u.f()}}r._source=null,this._disposeInstanceSpecificData(),this._disposeThinInstanceSpecificData(),this._internalMeshDataInfo._checkReadinessObserver&&this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),(0,i.Z)((0,h.Z)(n.prototype),"dispose",this).call(this,e,t)}},{key:"_disposeInstanceSpecificData",value:function(){}},{key:"_disposeThinInstanceSpecificData",value:function(){}},{key:"_invalidateInstanceVertexArrayObject",value:function(){}},{key:"applyDisplacementMap",value:function(e,t,n,r,a,i){var s=this,o=arguments.length>6&&void 0!==arguments[6]&&arguments[6],h=this.getScene(),l=function(e){var h=e.width,l=e.height,u=s.getEngine().createCanvas(h,l).getContext("2d");u.drawImage(e,0,0);var c=u.getImageData(0,0,h,l).data;s.applyDisplacementMapFromBuffer(c,h,l,t,n,a,i,o),r&&r(s)};return v.w1.LoadImage(e,l,(function(){}),h.offlineProvider),this}},{key:"applyDisplacementMapFromBuffer",value:function(e,t,n,r,a,i,s){var o=arguments.length>7&&void 0!==arguments[7]&&arguments[7];if(!this.isVerticesDataPresent(b.o.PositionKind)||!this.isVerticesDataPresent(b.o.NormalKind)||!this.isVerticesDataPresent(b.o.UVKind))return C.Y.Warn("Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing"),this;var h=this.getVerticesData(b.o.PositionKind,!0,!0),l=this.getVerticesData(b.o.NormalKind),u=this.getVerticesData(b.o.UVKind),c=I.P.Zero(),d=I.P.Zero(),f=I.FM.Zero();i=i||I.FM.Zero(),s=s||new I.FM(1,1);for(var v=0;v<h.length;v+=3){I.P.FromArrayToRef(h,v,c),I.P.FromArrayToRef(l,v,d),I.FM.FromArrayToRef(u,v/3*2,f);var g=Math.abs(f.x*s.x+i.x%1)*(t-1)%t|0,_=Math.abs(f.y*s.y+i.y%1)*(n-1)%n|0,m=4*(g+_*t),y=e[m]/255,p=e[m+1]/255,M=e[m+2]/255,S=.3*y+.59*p+.11*M;d.normalize(),d.scaleInPlace(r+(a-r)*S),(c=c.add(d)).toArray(h,v)}return D.x.ComputeNormals(h,this.getIndices(),l),o?(this.setVerticesData(b.o.PositionKind,h),this.setVerticesData(b.o.NormalKind,l),this.setVerticesData(b.o.UVKind,u)):(this.updateVerticesData(b.o.PositionKind,h),this.updateVerticesData(b.o.NormalKind,l)),this}},{key:"convertToFlatShadedMesh",value:function(){var e,t,n=this.getVerticesDataKinds(),r={},a={},i={},s=!1;for(e=0;e<n.length;e++){t=n[e];var o=this.getVertexBuffer(t),h=o.getData();(h instanceof Array||h instanceof Float32Array)&&0===h.length||(t!==b.o.NormalKind?(r[t]=o,a[t]=this.getVerticesData(t),i[t]=[]):(s=o.isUpdatable(),n.splice(e,1),e--))}var l,u=this.subMeshes.slice(0),c=this.getIndices(),d=this.getTotalIndices();for(l=0;l<d;l++){var f=c[l];for(e=0;e<n.length;e++)if(r[t=n[e]])for(var v=r[t].getStrideSize(),g=0;g<v;g++)i[t].push(a[t][f*v+g])}var _,m=[],y=i[b.o.PositionKind];for(_=this.getScene().useRightHandedSystem?1===this.overrideMaterialSideOrientation:0===this.overrideMaterialSideOrientation,l=0;l<d;l+=3){c[l]=l,c[l+1]=l+1,c[l+2]=l+2;var p=I.P.FromArray(y,3*l),M=I.P.FromArray(y,3*(l+1)),D=I.P.FromArray(y,3*(l+2)),S=p.subtract(M),x=D.subtract(M),A=I.P.Normalize(I.P.Cross(S,x));_&&A.scaleInPlace(-1);for(var k=0;k<3;k++)m.push(A.x),m.push(A.y),m.push(A.z)}for(this.setIndices(c),this.setVerticesData(b.o.NormalKind,m,s),e=0;e<n.length;e++)i[t=n[e]]&&this.setVerticesData(t,i[t],r[t].isUpdatable());this.releaseSubMeshes();for(var P=0;P<u.length;P++){var w=u[P];B.P.AddToMesh(w.materialIndex,w.indexStart,w.indexCount,w.indexStart,w.indexCount,this)}return this.synchronizeInstances(),this}},{key:"convertToUnIndexedMesh",value:function(){var e,t,n=this.getVerticesDataKinds(),r={},a={},i={};for(e=0;e<n.length;e++){t=n[e];var s=this.getVertexBuffer(t);r[t]=s,a[t]=r[t].getData(),i[t]=[]}var o,h=this.subMeshes.slice(0),l=this.getIndices(),u=this.getTotalIndices();for(o=0;o<u;o++){var c=l[o];for(e=0;e<n.length;e++)for(var d=r[t=n[e]].getStrideSize(),f=0;f<d;f++)i[t].push(a[t][c*d+f])}for(o=0;o<u;o+=3)l[o]=o,l[o+1]=o+1,l[o+2]=o+2;for(this.setIndices(l),e=0;e<n.length;e++)t=n[e],this.setVerticesData(t,i[t],r[t].isUpdatable(),r[t].getStrideSize());this.releaseSubMeshes();for(var v=0;v<h.length;v++){var g=h[v];B.P.AddToMesh(g.materialIndex,g.indexStart,g.indexCount,g.indexStart,g.indexCount,this)}return this._unIndexed=!0,this.synchronizeInstances(),this}},{key:"flipFaces",value:function(){var e,t,n=arguments.length>0&&void 0!==arguments[0]&&arguments[0],r=D.x.ExtractFromMesh(this);if(n&&this.isVerticesDataPresent(b.o.NormalKind)&&r.normals)for(e=0;e<r.normals.length;e++)r.normals[e]*=-1;if(r.indices)for(e=0;e<r.indices.length;e+=3)t=r.indices[e+1],r.indices[e+1]=r.indices[e+2],r.indices[e+2]=t;return r.applyToMesh(this,this.isVertexBufferUpdatable(b.o.PositionKind)),this}},{key:"increaseVertices",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=D.x.ExtractFromMesh(this),n=t.indices&&!Array.isArray(t.indices)&&Array.from?Array.from(t.indices):t.indices,r=t.positions&&!Array.isArray(t.positions)&&Array.from?Array.from(t.positions):t.positions,a=t.uvs&&!Array.isArray(t.uvs)&&Array.from?Array.from(t.uvs):t.uvs,i=t.normals&&!Array.isArray(t.normals)&&Array.from?Array.from(t.normals):t.normals;if(n&&r){t.indices=n,t.positions=r,a&&(t.uvs=a),i&&(t.normals=i);for(var s,o,h=e+1,l=new Array,u=0;u<h+1;u++)l[u]=new Array;var c,d,f,v=new I.P(0,0,0),g=new I.P(0,0,0),_=new I.FM(0,0),m=new Array,y=new Array,p=new Array,M=r.length;a&&(d=a.length),i&&(f=i.length);for(var S=0;S<n.length;S+=3){y[0]=n[S],y[1]=n[S+1],y[2]=n[S+2];for(var x=0;x<3;x++)if(s=y[x],o=y[(x+1)%3],void 0===p[s]&&void 0===p[o]?(p[s]=new Array,p[o]=new Array):(void 0===p[s]&&(p[s]=new Array),void 0===p[o]&&(p[o]=new Array)),void 0===p[s][o]&&void 0===p[o][s]){p[s][o]=[],v.x=(r[3*o]-r[3*s])/h,v.y=(r[3*o+1]-r[3*s+1])/h,v.z=(r[3*o+2]-r[3*s+2])/h,i&&(g.x=(i[3*o]-i[3*s])/h,g.y=(i[3*o+1]-i[3*s+1])/h,g.z=(i[3*o+2]-i[3*s+2])/h),a&&(_.x=(a[2*o]-a[2*s])/h,_.y=(a[2*o+1]-a[2*s+1])/h),p[s][o].push(s);for(var B=1;B<h;B++)p[s][o].push(r.length/3),r[M++]=r[3*s]+B*v.x,r[M++]=r[3*s+1]+B*v.y,r[M++]=r[3*s+2]+B*v.z,i&&(i[f++]=i[3*s]+B*g.x,i[f++]=i[3*s+1]+B*g.y,i[f++]=i[3*s+2]+B*g.z),a&&(a[d++]=a[2*s]+B*_.x,a[d++]=a[2*s+1]+B*_.y);p[s][o].push(o),p[o][s]=new Array,c=p[s][o].length;for(var A=0;A<c;A++)p[o][s][A]=p[s][o][c-1-A]}l[0][0]=n[S],l[1][0]=p[n[S]][n[S+1]][1],l[1][1]=p[n[S]][n[S+2]][1];for(var k=2;k<h;k++){l[k][0]=p[n[S]][n[S+1]][k],l[k][k]=p[n[S]][n[S+2]][k],v.x=(r[3*l[k][k]]-r[3*l[k][0]])/k,v.y=(r[3*l[k][k]+1]-r[3*l[k][0]+1])/k,v.z=(r[3*l[k][k]+2]-r[3*l[k][0]+2])/k,i&&(g.x=(i[3*l[k][k]]-i[3*l[k][0]])/k,g.y=(i[3*l[k][k]+1]-i[3*l[k][0]+1])/k,g.z=(i[3*l[k][k]+2]-i[3*l[k][0]+2])/k),a&&(_.x=(a[2*l[k][k]]-a[2*l[k][0]])/k,_.y=(a[2*l[k][k]+1]-a[2*l[k][0]+1])/k);for(var P=1;P<k;P++)l[k][P]=r.length/3,r[M++]=r[3*l[k][0]]+P*v.x,r[M++]=r[3*l[k][0]+1]+P*v.y,r[M++]=r[3*l[k][0]+2]+P*v.z,i&&(i[f++]=i[3*l[k][0]]+P*g.x,i[f++]=i[3*l[k][0]+1]+P*g.y,i[f++]=i[3*l[k][0]+2]+P*g.z),a&&(a[d++]=a[2*l[k][0]]+P*_.x,a[d++]=a[2*l[k][0]+1]+P*_.y)}l[h]=p[n[S+1]][n[S+2]],m.push(l[0][0],l[1][0],l[1][1]);for(var w=1;w<h;w++){var O=void 0;for(O=0;O<w;O++)m.push(l[w][O],l[w+1][O],l[w+1][O+1]),m.push(l[w][O],l[w+1][O+1],l[w][O+1]);m.push(l[w][O],l[w+1][O],l[w+1][O+1])}}t.indices=m,t.applyToMesh(this,this.isVertexBufferUpdatable(b.o.PositionKind))}else C.Y.Warn("Couldn't increase number of vertices : VertexData must contain at least indices and positions")}},{key:"forceSharedVertices",value:function(){var e=D.x.ExtractFromMesh(this),t=e.uvs,n=e.indices,r=e.positions,a=e.colors;if(void 0===n||void 0===r||null===n||null===r)C.Y.Warn("VertexData contains empty entries");else{for(var i,s,o=new Array,h=new Array,l=new Array,u=new Array,c=new Array,d=0,f={},v=0;v<n.length;v+=3){s=[n[v],n[v+1],n[v+2]],c=new Array;for(var g=0;g<3;g++){c[g]="";for(var _=0;_<3;_++)Math.abs(r[3*s[g]+_])<1e-8&&(r[3*s[g]+_]=0),c[g]+=r[3*s[g]+_]+"|"}if(c[0]!=c[1]&&c[0]!=c[2]&&c[1]!=c[2])for(var m=0;m<3;m++){if(void 0===(i=f[c[m]])){f[c[m]]=d,i=d++;for(var y=0;y<3;y++)o.push(r[3*s[m]+y]);if(null!=a)for(var I=0;I<4;I++)u.push(a[4*s[m]+I]);if(null!=t)for(var p=0;p<2;p++)l.push(t[2*s[m]+p])}h.push(i)}}var M=new Array;D.x.ComputeNormals(o,h,M),e.positions=o,e.indices=h,e.normals=M,null!=t&&(e.uvs=l),null!=a&&(e.colors=u),e.applyToMesh(this,this.isVertexBufferUpdatable(b.o.PositionKind))}}},{key:"createInstance",value:function(e){return n._instancedMeshFactory(e,this)}},{key:"synchronizeInstances",value:function(){for(var e=0;e<this.instances.length;e++){this.instances[e]._syncSubMeshes()}return this}},{key:"optimizeIndices",value:function(e){var t=this,n=this.getIndices(),r=this.getVerticesData(b.o.PositionKind);if(!r||!n)return this;for(var a=new Array,i=0;i<r.length;i+=3)a.push(I.P.FromArray(r,i));var s=new Array;return v.$g.SyncAsyncForLoop(a.length,40,(function(e){for(var t=a.length-1-e,n=a[t],r=0;r<t;++r){var i=a[r];if(n.equals(i)){s[t]=r;break}}}),(function(){for(var r=0;r<n.length;++r)n[r]=s[n[r]]||n[r];var a=t.subMeshes.slice(0);t.setIndices(n),t.subMeshes=a,e&&e(t)})),this}},{key:"serialize",value:function(e){e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,e.type=this.getClassName(),_.$&&_.$.HasTags(this)&&(e.tags=_.$.GetTags(this)),e.position=this.position.asArray(),this.rotationQuaternion?e.rotationQuaternion=this.rotationQuaternion.asArray():this.rotation&&(e.rotation=this.rotation.asArray()),e.scaling=this.scaling.asArray(),this._postMultiplyPivotMatrix?e.pivotMatrix=this.getPivotMatrix().asArray():e.localMatrix=this.getPivotMatrix().asArray(),e.isEnabled=this.isEnabled(!1),e.isVisible=this.isVisible,e.infiniteDistance=this.infiniteDistance,e.pickable=this.isPickable,e.receiveShadows=this.receiveShadows,e.billboardMode=this.billboardMode,e.visibility=this.visibility,e.checkCollisions=this.checkCollisions,e.isBlocker=this.isBlocker,e.overrideMaterialSideOrientation=this.overrideMaterialSideOrientation,this.parent&&this.parent._serializeAsParent(e),e.isUnIndexed=this.isUnIndexed;var t=this._geometry;if(t&&this.subMeshes){e.geometryUniqueId=t.uniqueId,e.geometryId=t.id,e.subMeshes=[];for(var n=0;n<this.subMeshes.length;n++){var r=this.subMeshes[n];e.subMeshes.push({materialIndex:r.materialIndex,verticesStart:r.verticesStart,verticesCount:r.verticesCount,indexStart:r.indexStart,indexCount:r.indexCount})}}if(this.material?this.material.doNotSerialize||(e.materialUniqueId=this.material.uniqueId,e.materialId=this.material.id):(this.material=null,e.materialUniqueId=this._scene.defaultMaterial.uniqueId,e.materialId=this._scene.defaultMaterial.id),this.morphTargetManager&&(e.morphTargetManagerId=this.morphTargetManager.uniqueId),this.skeleton&&(e.skeletonId=this.skeleton.id,e.numBoneInfluencers=this.numBoneInfluencers),this.getScene()._getComponent(T.l.NAME_PHYSICSENGINE)){var a=this.getPhysicsImpostor();a&&(e.physicsMass=a.getParam("mass"),e.physicsFriction=a.getParam("friction"),e.physicsRestitution=a.getParam("mass"),e.physicsImpostor=a.type)}this.metadata&&(e.metadata=this.metadata),e.instances=[];for(var i=0;i<this.instances.length;i++){var s=this.instances[i];if(!s.doNotSerialize){var o={name:s.name,id:s.id,isEnabled:s.isEnabled(!1),isVisible:s.isVisible,isPickable:s.isPickable,checkCollisions:s.checkCollisions,position:s.position.asArray(),scaling:s.scaling.asArray()};if(s.parent&&s.parent._serializeAsParent(o),s.rotationQuaternion?o.rotationQuaternion=s.rotationQuaternion.asArray():s.rotation&&(o.rotation=s.rotation.asArray()),this.getScene()._getComponent(T.l.NAME_PHYSICSENGINE)){var h=s.getPhysicsImpostor();h&&(o.physicsMass=h.getParam("mass"),o.physicsFriction=h.getParam("friction"),o.physicsRestitution=h.getParam("mass"),o.physicsImpostor=h.type)}s.metadata&&(o.metadata=s.metadata),e.instances.push(o),w.p4.AppendSerializedAnimations(s,o),o.ranges=s.serializeAnimationRanges()}}if(this._thinInstanceDataStorage.instancesCount&&this._thinInstanceDataStorage.matrixData&&(e.thinInstances={instancesCount:this._thinInstanceDataStorage.instancesCount,matrixData:Array.from(this._thinInstanceDataStorage.matrixData),matrixBufferSize:this._thinInstanceDataStorage.matrixBufferSize,enablePicking:this.thinInstanceEnablePicking},this._userThinInstanceBuffersStorage)){var l={data:{},sizes:{},strides:{}};for(var u in this._userThinInstanceBuffersStorage.data)l.data[u]=Array.from(this._userThinInstanceBuffersStorage.data[u]),l.sizes[u]=this._userThinInstanceBuffersStorage.sizes[u],l.strides[u]=this._userThinInstanceBuffersStorage.strides[u];e.thinInstances.userThinInstance=l}w.p4.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.layerMask=this.layerMask,e.alphaIndex=this.alphaIndex,e.hasVertexAlpha=this.hasVertexAlpha,e.overlayAlpha=this.overlayAlpha,e.overlayColor=this.overlayColor.asArray(),e.renderOverlay=this.renderOverlay,e.applyFog=this.applyFog,this.actionManager&&(e.actions=this.actionManager.serialize(this.name))}},{key:"_syncGeometryWithMorphTargetManager",value:function(){if(this.geometry){this._markSubMeshesAsAttributesDirty();var e=this._internalAbstractMeshDataInfo._morphTargetManager;if(e&&e.vertexCount){if(e.vertexCount!==this.getTotalVertices())return C.Y.Error("Mesh is incompatible with morph targets. Targets and mesh must all have the same vertices count."),void(this.morphTargetManager=null);if(e.isUsingTextureForTargets)return;for(var t=0;t<e.numInfluencers;t++){var n=e.getActiveTarget(t),r=n.getPositions();if(!r)return void C.Y.Error("Invalid morph target. Target must have positions.");this.geometry.setVerticesData(b.o.PositionKind+t,r,!1,3);var a=n.getNormals();a&&this.geometry.setVerticesData(b.o.NormalKind+t,a,!1,3);var i=n.getTangents();i&&this.geometry.setVerticesData(b.o.TangentKind+t,i,!1,3);var s=n.getUVs();s&&this.geometry.setVerticesData(b.o.UVKind+"_"+t,s,!1,2)}}else for(var o=0;this.geometry.isVerticesDataPresent(b.o.PositionKind+o);)this.geometry.removeVerticesData(b.o.PositionKind+o),this.geometry.isVerticesDataPresent(b.o.NormalKind+o)&&this.geometry.removeVerticesData(b.o.NormalKind+o),this.geometry.isVerticesDataPresent(b.o.TangentKind+o)&&this.geometry.removeVerticesData(b.o.TangentKind+o),this.geometry.isVerticesDataPresent(b.o.UVKind+o)&&this.geometry.removeVerticesData(b.o.UVKind+"_"+o),o++}}},{key:"setPositionsForCPUSkinning",value:function(){var e=this._internalMeshDataInfo;if(!e._sourcePositions){var t=this.getVerticesData(b.o.PositionKind);if(!t)return e._sourcePositions;e._sourcePositions=new Float32Array(t),this.isVertexBufferUpdatable(b.o.PositionKind)||this.setVerticesData(b.o.PositionKind,t,!0)}return e._sourcePositions}},{key:"setNormalsForCPUSkinning",value:function(){var e=this._internalMeshDataInfo;if(!e._sourceNormals){var t=this.getVerticesData(b.o.NormalKind);if(!t)return e._sourceNormals;e._sourceNormals=new Float32Array(t),this.isVertexBufferUpdatable(b.o.NormalKind)||this.setVerticesData(b.o.NormalKind,t,!0)}return e._sourceNormals}},{key:"applySkeleton",value:function(e){if(!this.geometry)return this;if(this.geometry._softwareSkinningFrameId==this.getScene().getFrameId())return this;if(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(b.o.PositionKind))return this;if(!this.isVerticesDataPresent(b.o.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(b.o.MatricesWeightsKind))return this;var t=this.isVerticesDataPresent(b.o.NormalKind),n=this._internalMeshDataInfo;if(!n._sourcePositions){var r=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=r}t&&!n._sourceNormals&&this.setNormalsForCPUSkinning();var a=this.getVerticesData(b.o.PositionKind);if(!a)return this;a instanceof Float32Array||(a=new Float32Array(a));var i=this.getVerticesData(b.o.NormalKind);if(t){if(!i)return this;i instanceof Float32Array||(i=new Float32Array(i))}var s=this.getVerticesData(b.o.MatricesIndicesKind),o=this.getVerticesData(b.o.MatricesWeightsKind);if(!o||!s)return this;for(var h,l=this.numBoneInfluencers>4,u=l?this.getVerticesData(b.o.MatricesIndicesExtraKind):null,c=l?this.getVerticesData(b.o.MatricesWeightsExtraKind):null,d=e.getTransformMatrices(this),f=I.P.Zero(),v=new I.y3,g=new I.y3,_=0,m=0;m<a.length;m+=3,_+=4){var y=void 0;for(h=0;h<4;h++)(y=o[_+h])>0&&(I.y3.FromFloat32ArrayToRefScaled(d,Math.floor(16*s[_+h]),y,g),v.addToSelf(g));if(l)for(h=0;h<4;h++)(y=c[_+h])>0&&(I.y3.FromFloat32ArrayToRefScaled(d,Math.floor(16*u[_+h]),y,g),v.addToSelf(g));I.P.TransformCoordinatesFromFloatsToRef(n._sourcePositions[m],n._sourcePositions[m+1],n._sourcePositions[m+2],v,f),f.toArray(a,m),t&&(I.P.TransformNormalFromFloatsToRef(n._sourceNormals[m],n._sourceNormals[m+1],n._sourceNormals[m+2],v,f),f.toArray(i,m)),v.reset()}return this.updateVerticesData(b.o.PositionKind,a),t&&this.updateVerticesData(b.o.NormalKind,i),this}},{key:"addInstance",value:function(e){e._indexInSourceMeshInstanceArray=this.instances.length,this.instances.push(e)}},{key:"removeInstance",value:function(e){var t=e._indexInSourceMeshInstanceArray;if(-1!=t){if(t!==this.instances.length-1){var n=this.instances[this.instances.length-1];this.instances[t]=n,n._indexInSourceMeshInstanceArray=t}e._indexInSourceMeshInstanceArray=-1,this.instances.pop()}}},{key:"_shouldConvertRHS",value:function(){return this.overrideMaterialSideOrientation===A.F.CounterClockWiseSideOrientation}}],[{key:"_GetDefaultSideOrientation",value:function(e){return e||n.FRONTSIDE}},{key:"_instancedMeshFactory",value:function(e,t){throw(0,F.S)("InstancedMesh")}},{key:"_PhysicsImpostorParser",value:function(e,t,n){throw(0,F.S)("PhysicsImpostor")}},{key:"Parse",value:function(e,t,r){var a;if((a=e.type&&"LinesMesh"===e.type?n._LinesMeshParser(e,t):e.type&&"GroundMesh"===e.type?n._GroundMeshParser(e,t):e.type&&"GoldbergMesh"===e.type?n._GoldbergMeshParser(e,t):new n(e.name,t)).id=e.id,a._waitingParsedUniqueId=e.uniqueId,_.$&&_.$.AddTagsTo(a,e.tags),a.position=I.P.FromArray(e.position),void 0!==e.metadata&&(a.metadata=e.metadata),e.rotationQuaternion?a.rotationQuaternion=I._f.FromArray(e.rotationQuaternion):e.rotation&&(a.rotation=I.P.FromArray(e.rotation)),a.scaling=I.P.FromArray(e.scaling),e.localMatrix?a.setPreTransformMatrix(I.y3.FromArray(e.localMatrix)):e.pivotMatrix&&a.setPivotMatrix(I.y3.FromArray(e.pivotMatrix)),a.setEnabled(e.isEnabled),a.isVisible=e.isVisible,a.infiniteDistance=e.infiniteDistance,a.showBoundingBox=e.showBoundingBox,a.showSubMeshesBoundingBox=e.showSubMeshesBoundingBox,void 0!==e.applyFog&&(a.applyFog=e.applyFog),void 0!==e.pickable&&(a.isPickable=e.pickable),void 0!==e.alphaIndex&&(a.alphaIndex=e.alphaIndex),a.receiveShadows=e.receiveShadows,a.billboardMode=e.billboardMode,void 0!==e.visibility&&(a.visibility=e.visibility),a.checkCollisions=e.checkCollisions,a.overrideMaterialSideOrientation=e.overrideMaterialSideOrientation,void 0!==e.isBlocker&&(a.isBlocker=e.isBlocker),a._shouldGenerateFlatShading=e.useFlatShading,e.freezeWorldMatrix&&(a._waitingData.freezeWorldMatrix=e.freezeWorldMatrix),void 0!==e.parentId&&(a._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(a._waitingParentInstanceIndex=e.parentInstanceIndex),void 0!==e.actions&&(a._waitingData.actions=e.actions),void 0!==e.overlayAlpha&&(a.overlayAlpha=e.overlayAlpha),void 0!==e.overlayColor&&(a.overlayColor=p.Wo.FromArray(e.overlayColor)),void 0!==e.renderOverlay&&(a.renderOverlay=e.renderOverlay),a.isUnIndexed=!!e.isUnIndexed,a.hasVertexAlpha=e.hasVertexAlpha,e.delayLoadingFile?(a.delayLoadState=4,a.delayLoadingFile=r+e.delayLoadingFile,a.buildBoundingInfo(I.P.FromArray(e.boundingBoxMinimum),I.P.FromArray(e.boundingBoxMaximum)),e._binaryInfo&&(a._binaryInfo=e._binaryInfo),a._delayInfo=[],e.hasUVs&&a._delayInfo.push(b.o.UVKind),e.hasUVs2&&a._delayInfo.push(b.o.UV2Kind),e.hasUVs3&&a._delayInfo.push(b.o.UV3Kind),e.hasUVs4&&a._delayInfo.push(b.o.UV4Kind),e.hasUVs5&&a._delayInfo.push(b.o.UV5Kind),e.hasUVs6&&a._delayInfo.push(b.o.UV6Kind),e.hasColors&&a._delayInfo.push(b.o.ColorKind),e.hasMatricesIndices&&a._delayInfo.push(b.o.MatricesIndicesKind),e.hasMatricesWeights&&a._delayInfo.push(b.o.MatricesWeightsKind),a._delayLoadingFunction=S.Z._ImportGeometry,P.Z.ForceFullSceneLoadingForIncremental&&a._checkDelayState()):S.Z._ImportGeometry(e,a),e.materialUniqueId?a._waitingMaterialId=e.materialUniqueId:e.materialId&&(a._waitingMaterialId=e.materialId),e.morphTargetManagerId>-1&&(a.morphTargetManager=t.getMorphTargetManagerById(e.morphTargetManagerId)),void 0!==e.skeletonId&&null!==e.skeletonId&&(a.skeleton=t.getLastSkeletonById(e.skeletonId),e.numBoneInfluencers&&(a.numBoneInfluencers=e.numBoneInfluencers)),e.animations){for(var i=0;i<e.animations.length;i++){var s=e.animations[i],o=(0,O.q)("BABYLON.Animation");o&&a.animations.push(o.Parse(s))}M.N.ParseAnimationRanges(a,e,t)}if(e.autoAnimate&&t.beginAnimation(a,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.layerMask&&!isNaN(e.layerMask)?a.layerMask=Math.abs(parseInt(e.layerMask)):a.layerMask=268435455,e.physicsImpostor&&n._PhysicsImpostorParser(t,a,e),e.lodMeshIds&&(a._waitingData.lods={ids:e.lodMeshIds,distances:e.lodDistances?e.lodDistances:null,coverages:e.lodCoverages?e.lodCoverages:null}),e.instances)for(var h=0;h<e.instances.length;h++){var l=e.instances[h],u=a.createInstance(l.name);if(l.id&&(u.id=l.id),_.$&&(l.tags?_.$.AddTagsTo(u,l.tags):_.$.AddTagsTo(u,e.tags)),u.position=I.P.FromArray(l.position),void 0!==l.metadata&&(u.metadata=l.metadata),void 0!==l.parentId&&(u._waitingParentId=l.parentId),void 0!==l.parentInstanceIndex&&(u._waitingParentInstanceIndex=l.parentInstanceIndex),void 0!==l.isEnabled&&null!==l.isEnabled&&u.setEnabled(l.isEnabled),void 0!==l.isVisible&&null!==l.isVisible&&(u.isVisible=l.isVisible),void 0!==l.isPickable&&null!==l.isPickable&&(u.isPickable=l.isPickable),l.rotationQuaternion?u.rotationQuaternion=I._f.FromArray(l.rotationQuaternion):l.rotation&&(u.rotation=I.P.FromArray(l.rotation)),u.scaling=I.P.FromArray(l.scaling),null!=l.checkCollisions&&null!=l.checkCollisions&&(u.checkCollisions=l.checkCollisions),null!=l.pickable&&null!=l.pickable&&(u.isPickable=l.pickable),null!=l.showBoundingBox&&null!=l.showBoundingBox&&(u.showBoundingBox=l.showBoundingBox),null!=l.showSubMeshesBoundingBox&&null!=l.showSubMeshesBoundingBox&&(u.showSubMeshesBoundingBox=l.showSubMeshesBoundingBox),null!=l.alphaIndex&&null!=l.showSubMeshesBoundingBox&&(u.alphaIndex=l.alphaIndex),l.physicsImpostor&&n._PhysicsImpostorParser(t,u,l),l.animations){for(var c=0;c<l.animations.length;c++){var d=l.animations[c],f=(0,O.q)("BABYLON.Animation");f&&u.animations.push(f.Parse(d))}M.N.ParseAnimationRanges(u,l,t),l.autoAnimate&&t.beginAnimation(u,l.autoAnimateFrom,l.autoAnimateTo,l.autoAnimateLoop,l.autoAnimateSpeed||1)}}if(e.thinInstances){var v=e.thinInstances;if(a.thinInstanceEnablePicking=!!v.enablePicking,v.matrixData?(a.thinInstanceSetBuffer("matrix",new Float32Array(v.matrixData),16,!1),a._thinInstanceDataStorage.matrixBufferSize=v.matrixBufferSize,a._thinInstanceDataStorage.instancesCount=v.instancesCount):a._thinInstanceDataStorage.matrixBufferSize=v.matrixBufferSize,e.thinInstances.userThinInstance){var g=e.thinInstances.userThinInstance;for(var m in g.data)a.thinInstanceSetBuffer(m,new Float32Array(g.data[m]),g.strides[m],!1),a._userThinInstanceBuffersStorage.sizes[m]=g.sizes[m]}}return a}},{key:"MinMax",value:function(e){var t=null,n=null;return e.forEach((function(e){var r=e.getBoundingInfo().boundingBox;t&&n?(t.minimizeInPlace(r.minimumWorld),n.maximizeInPlace(r.maximumWorld)):(t=r.minimumWorld,n=r.maximumWorld)})),t&&n?{min:t,max:n}:{min:I.P.Zero(),max:I.P.Zero()}}},{key:"Center",value:function(e){var t=e instanceof Array?n.MinMax(e):e;return I.P.Center(t.min,t.max)}},{key:"MergeMeshes",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=arguments.length>2?arguments[2]:void 0,a=arguments.length>3?arguments[3]:void 0,i=arguments.length>4?arguments[4]:void 0,s=arguments.length>5?arguments[5]:void 0;return(0,m.s3)(n._MergeMeshesCoroutine(e,t,r,a,i,s,!1))}},{key:"MergeMeshesAsync",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=arguments.length>2?arguments[2]:void 0,a=arguments.length>3?arguments[3]:void 0,i=arguments.length>4?arguments[4]:void 0,s=arguments.length>5?arguments[5]:void 0;return(0,m.sM)(n._MergeMeshesCoroutine(e,t,r,a,i,s,!0),(0,m.KO)())}},{key:"_MergeMeshesCoroutine",value:d().mark((function e(t){var a,i,s,o,h,l,u,c,f,v,g,_,m,y,I,p,M,b,S,x,A,P,w,O,F,T,V,L,E,W,N,K,z,U,Z,G=arguments;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=!(G.length>1&&void 0!==G[1])||G[1],i=G.length>2?G[2]:void 0,s=G.length>3?G[3]:void 0,o=G.length>4?G[4]:void 0,h=G.length>5?G[5]:void 0,l=G.length>6?G[6]:void 0,0!==(t=t.filter(Boolean)).length){e.next=9;break}return e.abrupt("return",null);case 9:if(i){e.next=20;break}c=0,u=0;case 12:if(!(u<t.length)){e.next=20;break}if(!((c+=t[u].getTotalVertices())>=65536)){e.next=17;break}return C.Y.Warn("Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices"),e.abrupt("return",null);case 17:u++,e.next=12;break;case 20:h&&(o=!1),f=new Array,v=new Array,g=new Array,_=t[0].overrideMaterialSideOrientation,u=0;case 26:if(!(u<t.length)){e.next=39;break}if(!(m=t[u]).isAnInstance){e.next=31;break}return C.Y.Warn("Cannot merge instance meshes."),e.abrupt("return",null);case 31:if(_===m.overrideMaterialSideOrientation){e.next=34;break}return C.Y.Warn("Cannot merge meshes with different overrideMaterialSideOrientation values."),e.abrupt("return",null);case 34:if(o&&g.push(m.getTotalIndices()),h)if(m.material)if((y=m.material)instanceof k.G){for(I=0;I<y.subMaterials.length;I++)f.indexOf(y.subMaterials[I])<0&&f.push(y.subMaterials[I]);for(p=0;p<m.subMeshes.length;p++)v.push(f.indexOf(y.subMaterials[m.subMeshes[p].materialIndex])),g.push(m.subMeshes[p].indexCount)}else for(f.indexOf(y)<0&&f.push(y),M=0;M<m.subMeshes.length;M++)v.push(f.indexOf(y)),g.push(m.subMeshes[M].indexCount);else for(b=0;b<m.subMeshes.length;b++)v.push(0),g.push(m.subMeshes[b].indexCount);case 36:u++,e.next=26;break;case 39:if(S=t[0],x=function(e){var t=e.computeWorldMatrix(!0);return[D.x.ExtractFromMesh(e,!1,!1),t]},A=x(S),P=(0,r.Z)(A,2),w=P[0],O=P[1],!l){e.next=45;break}return void(e.next=45);case 45:F=new Array(t.length-1),T=1;case 47:if(!(T<t.length)){e.next=55;break}if(F[T-1]=x(t[T]),!l){e.next=52;break}return void(e.next=52);case 52:T++,e.next=47;break;case 55:V=w._mergeCoroutine(O,F,i,l,!a),L=V.next();case 57:if(L.done){e.next=64;break}if(!l){e.next=61;break}return void(e.next=61);case 61:L=V.next(),e.next=57;break;case 64:E=L.value,s||(s=new n(S.name+"_merged",S.getScene())),W=E._applyToCoroutine(s,void 0,l),N=W.next();case 68:if(N.done){e.next=75;break}if(!l){e.next=72;break}return void(e.next=72);case 72:N=W.next(),e.next=68;break;case 75:if(s.checkCollisions=S.checkCollisions,s.overrideMaterialSideOrientation=S.overrideMaterialSideOrientation,a)for(u=0;u<t.length;u++)t[u].dispose();if(o||h){for(s.releaseSubMeshes(),u=0,K=0;u<g.length;)B.P.CreateFromIndices(0,K,g[u],s,void 0,!1),K+=g[u],u++;z=R(s.subMeshes);try{for(z.s();!(U=z.n()).done;)U.value.refreshBoundingInfo()}catch(d){z.e(d)}finally{z.f()}s.computeWorldMatrix(!0)}if(h){for((Z=new k.G(S.name+"_merged",S.getScene())).subMaterials=f,p=0;p<s.subMeshes.length;p++)s.subMeshes[p].materialIndex=v[p];s.material=Z}else s.material=S.material;return e.abrupt("return",s);case 81:case"end":return e.stop()}}),e)}))}]),n}(x.x);U.FRONTSIDE=D.x.FRONTSIDE,U.BACKSIDE=D.x.BACKSIDE,U.DOUBLESIDE=D.x.DOUBLESIDE,U.DEFAULTSIDE=D.x.DEFAULTSIDE,U.NO_CAP=0,U.CAP_START=1,U.CAP_END=2,U.CAP_ALL=3,U.NO_FLIP=0,U.FLIP_TILE=1,U.ROTATE_TILE=2,U.FLIP_ROW=3,U.ROTATE_ROW=4,U.FLIP_N_ROTATE_TILE=5,U.FLIP_N_ROTATE_ROW=6,U.CENTER=0,U.LEFT=1,U.RIGHT=2,U.TOP=3,U.BOTTOM=4,U.INSTANCEDMESH_SORT_TRANSPARENT=!1,U._GroundMeshParser=function(e,t){throw(0,F.S)("GroundMesh")},U._GoldbergMeshParser=function(e,t){throw(0,F.S)("GoldbergMesh")},U._LinesMeshParser=function(e,t){throw(0,F.S)("LinesMesh")},(0,O.H)("BABYLON.Mesh",U),U.prototype.setMaterialByID=function(e){return this.setMaterialById(e)},U.CreateDisc=U.CreateDisc||function(){throw new Error("Import MeshBuilder to populate this function")},U.CreateBox=U.CreateBox||function(){throw new Error("Import MeshBuilder to populate this function")},U.CreateSphere=U.CreateSphere||function(){throw new Error("Import MeshBuilder to populate this function")},U.CreateCylinder=U.CreateCylinder||function(){throw new Error("Import MeshBuilder to populate this function")},U.CreateTorusKnot=U.CreateTorusKnot||function(){throw new Error("Import MeshBuilder to populate this function")},U.CreateTorus=U.CreateTorus||function(){throw new Error("Import MeshBuilder to populate this function")},U.CreatePlane=U.CreatePlane||function(){throw new Error("Import MeshBuilder to populate this function")},U.CreateGround=U.CreateGround||function(){throw new Error("Import MeshBuilder to populate this function")},U.CreateTiledGround=U.CreateTiledGround||function(){throw new Error("Import MeshBuilder to populate this function")},U.CreateGroundFromHeightMap=U.CreateGroundFromHeightMap||function(){throw new Error("Import MeshBuilder to populate this function")},U.CreateTube=U.CreateTube||function(){throw new Error("Import MeshBuilder to populate this function")},U.CreatePolyhedron=U.CreatePolyhedron||function(){throw new Error("Import MeshBuilder to populate this function")},U.CreateIcoSphere=U.CreateIcoSphere||function(){throw new Error("Import MeshBuilder to populate this function")},U.CreateDecal=U.CreateDecal||function(){throw new Error("Import MeshBuilder to populate this function")},U.CreateCapsule=U.CreateCapsule||function(){throw new Error("Import MeshBuilder to populate this function")},U.ExtendToGoldberg=U.ExtendToGoldberg||function(){throw new Error("Import MeshBuilder to populate this function")}}}]);
//# sourceMappingURL=87a06baf-a5ff3362a2b2680296b2.js.map